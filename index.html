<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>THE-DOT-MAN - Sign In</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; }
    .container { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); width: 100%; max-width: 400px; }
    .dashboard-container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); width: 95%; max-width: 1200px; margin: 20px; }
    .logo { text-align: center; margin-bottom: 30px; }
    .logo h1 { color: #667eea; font-size: 28px; font-weight: bold; }
    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 8px; color: #333; font-weight: 500; }
    input[type="text"], input[type="password"] { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 5px; font-size: 14px; transition: border-color 0.3s; }
    input[type="text"]:focus, input[type="password"]:focus { outline: none; border-color: #667eea; }
    .btn { width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 5px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.2s; }
    .btn:hover { transform: translateY(-2px); }
    .error-message { color: #e74c3c; font-size: 14px; margin-top: 10px; text-align: center; display: none; }
    .hidden { display: none; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #e0e0e0; }
    .header h2 { color: #667eea; font-size: 24px; }
    .logout-btn { padding: 10px 20px; background: #e74c3c; color: white; border: none; border-radius: 5px; font-size: 14px; font-weight: 600; cursor: pointer; transition: background 0.3s; }
    .logout-btn:hover { background: #c0392b; }
    .info-box { background: #e8f4f8; border-left: 4px solid #3498db; padding: 15px; margin-bottom: 25px; border-radius: 5px; }
    .info-box h3 { color: #2c3e50; margin-bottom: 10px; font-size: 16px; }
    .info-box p { color: #555; font-size: 14px; line-height: 1.6; }
    .info-box code { background: #fff; padding: 2px 6px; border-radius: 3px; font-family: 'Courier New', monospace; color: #e74c3c; }
    .inbox-section { margin-top: 20px; }
    .inbox-section h3 { color: #2c3e50; margin-bottom: 15px; font-size: 20px; }
    .inbox-table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); border-radius: 5px; overflow: hidden; }
    .inbox-table thead { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .inbox-table th { padding: 15px; text-align: left; font-weight: 600; font-size: 14px; }
    .inbox-table td { padding: 15px; border-bottom: 1px solid #e0e0e0; color: #555; font-size: 14px; }
    .inbox-table tbody tr:hover { background: #f8f9fa; }
    .inbox-table td.empty-inbox { text-align: center; color: #999; font-style: italic; padding: 30px; }
    .status { margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; color: #555; font-size: 14px; }
    .status .error { color: #e74c3c; font-weight: 600; }
  </style>
</head>
<body>
  <div id="loginView" class="container">
    <div class="logo"><h1>THE-DOT-MAN</h1></div>
    <form id="loginForm">
      <div class="form-group"><label for="username">Username</label><input type="text" id="username" placeholder="Enter your username" required /></div>
      <div class="form-group"><label for="password">Password</label><input type="password" id="password" placeholder="Enter your password" required /></div>
      <button type="submit" class="btn">Sign In</button>
      <div id="errorMessage" class="error-message"></div>
    </form>
  </div>
  <div id="dashboardView" class="dashboard-container hidden">
    <div class="header"><h2>THE-DOT-MAN Dashboard</h2><button id="logoutBtn" class="logout-btn">Logout</button></div>
    <div class="info-box">
      <h3>âœ… Emailer Dashboard Active</h3>
      <p>This frontend now fetches <strong>real inbox data</strong> from your live backend at <code>https://the-dot-man-backend.onrender.com/inbox</code>.</p>
    </div>
    <div class="status" id="statusMessage">Loading emails...</div>
    <div class="inbox-section">
      <h3>ðŸ“¥ Inbox</h3>
      <table class="inbox-table"><thead><tr><th>From</th><th>Subject</th><th>Date</th><th>Body</th></tr></thead><tbody id="inboxBody"><tr><td class="empty-inbox" colspan="4">Loading...</td></tr></tbody></table>
    </div>
  </div>
  <script>
    const loginForm = document.getElementById('loginForm');
    const loginView = document.getElementById('loginView');
    const dashboardView = document.getElementById('dashboardView');
    const errorMessage = document.getElementById('errorMessage');
    const logoutBtn = document.getElementById('logoutBtn');
    const BACKEND_URL = 'https://the-dot-man-backend.onrender.com/inbox';

    // Handle login
    loginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      if (username === 'admin' && password === 'password123') {
        loginView.classList.add('hidden');
        dashboardView.classList.remove('hidden');
        errorMessage.style.display = 'none';
        fetchEmails();
      } else {
        errorMessage.textContent = 'Invalid username or password';
        errorMessage.style.display = 'block';
      }
    });

    // Handle logout
    logoutBtn.addEventListener('click', () => {
      dashboardView.classList.add('hidden');
      loginView.classList.remove('hidden');
      document.getElementById('username').value = '';
      document.getElementById('password').value = '';
    });

    // Fetch emails from backend
    async function fetchEmails() {
      const statusEl = document.getElementById('statusMessage');
      const inboxBody = document.getElementById('inboxBody');
      statusEl.textContent = 'Fetching emails from backend...';
      try {
        const res = await fetch(BACKEND_URL, { method: 'GET', headers: { 'Accept': 'application/json' } });
        if (!res.ok) {
          const text = await res.text().catch(() => '');
          throw new Error(`Backend responded ${res.status}: ${text || res.statusText}`);
        }
        const data = await res.json();
        // Support either { emails: [...] } or direct array
        const emails = Array.isArray(data) ? data : (data.emails || []);
        if (!Array.isArray(emails)) {
          throw new Error('Invalid response format: expected array or { emails: [] }');
        }
        displayEmails(emails);
        statusEl.textContent = emails.length ? `Loaded ${emails.length} email(s).` : 'No emails found.';
      } catch (err) {
        console.error('Error fetching emails:', err);
        statusEl.innerHTML = `<span class="error">Failed to fetch emails. ${escapeHtml(err.message)}. Ensure the backend at ${escapeHtml(BACKEND_URL)} is reachable and returns JSON.</span>`;
        inboxBody.innerHTML = '<tr><td class="empty-inbox" colspan="4">Unable to load emails. Check backend status.</td></tr>';
      }
    }

    // Display emails in the table
    function displayEmails(emails) {
      const inboxBody = document.getElementById('inboxBody');
      if (emails.length === 0) {
        inboxBody.innerHTML = '<tr><td class="empty-inbox" colspan="4">No emails found.</td></tr>';
        return;
      }
      inboxBody.innerHTML = emails.map(email => `
        <tr>
          <td>${escapeHtml(email.from || '')}</td>
          <td><strong>${escapeHtml(email.subject || '')}</strong></td>
          <td>${escapeHtml(email.date || '')}</td>
          <td>${escapeHtml(email.body || '')}</td>
        </tr>
      `).join('');
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = String(text ?? '');
      return div.innerHTML;
    }
  </script>
</body>
</html>
